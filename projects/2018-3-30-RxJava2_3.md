---
layout: post
title: RxJava2 세 번째, Retrofit 적용하기
category: [rxjava, reactive-programming]
author: hyungsun
image: assets/images/rxjava_2.png
---

## Index
---
- [RxJava2 첫 번째, RxJava에 관하여]({{site.url}}/RxJava2_1)
- [RxJava2 두 번째, 간단한 프로젝트 생성해보기]({{site.url}}/RxJava2_2)
- RxJava2 세 번째, Retrofit 적용하기

## Prologue
---
[RxJava 두 번째 이야기]({{ site.url }}/RxJava2_2/){:target="_blank"} 에서 간단한 온도계를 만들어봤지만, RxJava를 이용했다고 말할 수는 없는 수준이라 조금 더 들어가 보기로 했다. 특히, 저번 포스팅에서 '귀찮아서' api에서 가져오는 부분은 쓰레드로 대체하겠다고 이야기 했지만 문득 '귀찮음'과 '할 줄 모름'은 한 끝 차이 아닌가 싶어서 해보기로 했다. ~~그렇잖아도 겁나게 못하면서~~ 귀찮다고 안 한다면 도대체 언제 실력이 늘겠는가. 

이 프로젝트에서 구현할 기능은 역시 저번처럼 매우 간단하다. (사실 복잡한 건 할 줄 모른다)
- 나의 개인 깃헙 계정([poqw](https://github.com/poqw){:target="_blank"})의 public repository를 가져와 메인화면에 display한다.
- display할 때는 [Recycler View](https://developer.android.com/reference/android/support/v7/widget/RecyclerView.html){:target="_blank"}를 이용한다.


## Monologue
---

### 1. Retrofit, Recycler View를 프로젝트에 적용하기
아래 dependencies들을 gradle파일에 추가해 주면 된다. 추가 한 뒤 gradle sync 하는 걸 잊지 말자.

```gradle
dependencies {
  ...
  // Android Support.
  implementation 'com.android.support:recyclerview-v7:26.1.0'
  implementation 'com.android.support:cardview-v7:26.1.0'

  // Retrofit2.
  implementation 'com.squareup.retrofit2:retrofit:2.3.0'
  implementation 'com.squareup.retrofit2:adapter-rxjava2:2.3.0'
  implementation 'com.squareup.retrofit2:converter-gson:2.3.0'
  ...
}
```
Recycler View 안에서는 CardView 형식으로 아이템들을 나열할 것이기 때문에 cardview도 gradle에 명시해 주었다. 

Retrofit2 관련해서 추가한 부분을 보자. 우선 retrofit 자체는 당연히 Retrofit2를 쓰려고 선언해 놓은 것이다. 간단하게 사용하는 방법을 집고 넘어가자.
```java
public interface GerritAPI {
    @GET("changes/")
    Call<List<Change>> loadChanges(@Query("q") String status);
}
```
`@GET` annotation은 GET Method를 사용하겠다는 것이고, (url)의 url은 요청보내는 path, `@Query` annotation은 `...&q?={status}`처럼 쿼리 파라미터를 만들어 주겠다는 것이다. 응답이 성공한다면, 해당 데이터를 `List<Change>`로 바꾸어 준 뒤 `Call`로 wrap해서 반환한다(`Call`은 밑에서 다시 설명하겠다). 정말 매우 직관적이지 않은가? 어쩜 이렇게 예쁘게 만들 수 있었을까. 잠깐 마음 속 깊이 존경하는 시간을 가진 뒤 다음으로 넘어가자.

두 번째로 adapter-rxjava2를 추가해 놓은 이유는 이름 그대로 Rxjava와 Retrofit2을 연결하기 위한 어뎁터로 사용하기 위해 추가했다. 정확히는 `RxJava2CallAdapterFactory`를 사용하기 위함이다.

```java
Retrofit retrofit = new Retrofit.Builder()
    .baseUrl("https://example.com/")
    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())
    .build();
```
위와 같이 retrofit instance를 빌드 할 때 `RxJava2CallAdapterFactory`를 추가해 주면 아래처럼 `Observable`이나 `Single`같은 타입을 뱉을 수 있게 된다.

```java
// Without adapter.
interface MyService {
  @GET("/user")
  Call<User> getUser();
}

// With adapter.
interface MyService {
  @GET("/user")
  Observable<User> getUser();
}
```
원래는 [`Call`](https://square.github.io/retrofit/2.x/retrofit/retrofit2/Call.html){:target="_blank"}이라는 retrofit 의 Reponse handle type을 사용해야 하지만 여기에 어뎁터를 끼워서 Reactive instance들을 반환하도록 한 것이다. 

마지막으로 converter-gson은 어댑터를 추가한 이유와 비슷하다. 바로 `addConverterFactory`를 써먹기 위해서다. 나중에 나올 코드에 적용되어 있을 것이므로 사용예제는 적지 않겠다. Retrofit에서는 서버와의 통신을 통해 받아온 데이터를 사용자가 원하는 형식으로 데이터를 변환하기 위한 converter를 지원한다. 그런데 이 converter를 만드는 것 역시 번거로우므로, 'Gson Converter 쓸 사람들은 이걸 쓰세요' 하고서 converter-gson을 만들어 놓은 것이다.

다른 형식(이를 테면 Json)으로 (de)serialization을 하고 싶다면, [여기](https://github.com/square/retrofit/wiki/Converters){:target="_blank"}를 참고하자.

### 2. Core code
[기존 코드](https://gist.github.com/poqw/139310db9f33505bc845e16608ebe1fe){:target="_blank"}에서 많이 변경되었지만, 가장 중요한 변경 사항은 api 서버와의 통신을 처리하는 `GithubApi` 와 `GithubClient`가 생겼다는 것이다.

GithubApi.java
```java
public interface GithubApi {
  @GET("users/{owner}/repos")
  Single<List<GithubRepo>> getRepos(@Path("owner") String owner);
}
```
위에서 소개하지 않은 `{owner}`때문에 의아해 하는 분도 있을텐데, 어렵지 않다. `@Query` Annotation과 하는 역할이 비슷한데, Path에다가 `owner`를 대입해준다. Api요청 시 `owner`가 'poqw'면 "users/poqw/repos"에다 요청하는 식이다. 

GithubClient.java
```java
public class GithubClient {
  private static final String BASE_URL = "https://api.github.com";

  private static final class GithubRepoDeserializer implements JsonDeserializer<GithubRepo> {
    @Override
    public GithubRepo deserialize(JsonElement json, Type type, JsonDeserializationContext context)
        throws JsonParseException {
      GithubRepo githubRepo = new GithubRepo();
      JsonObject repoJsonObject =  json.getAsJsonObject();
      JsonElement ownerJsonElement = repoJsonObject.get("owner");
      JsonObject ownerJsonObject = ownerJsonElement.getAsJsonObject();

      githubRepo.name = repoJsonObject.get("name").getAsString();
      githubRepo.url = repoJsonObject.get("url").getAsString();
      githubRepo.owner = ownerJsonObject.get("login").getAsString();
      return githubRepo;
    }
  }

  public GithubApi getApi() {
    Gson gson = new GsonBuilder()
        .registerTypeAdapter(GithubRepo.class, new GithubRepoDeserializer())
        .create();
    return new Retrofit.Builder()
        .baseUrl(BASE_URL)
        .client(new OkHttpClient())
        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())
        .addConverterFactory(GsonConverterFactory.create(gson))
        .build()
        .create(GithubApi.class);
  }
}
```
위에서 언급했던 `addConverterFactory`가 여기서 쓰였다. 이미 gson-converter를 통해 응답이 gson으로 바뀌어 있을 것이므로, `GithubRepoDeserializer`를 이용해 gson을 직접 사용할 수 있게 내가 미리 정의해놓은 `GithubRepo` POJO(Plain Old Java Object)로 바꾸어 준다. `GithubRepo`는 아래와 같이 (못)생겼다.

GithubRepo.java
```java
public class GithubRepo {
  public String name;
  public String owner;
  public String url;
}
```

지금까지 Api에서 응답을 받아와 내가 처리할 수 있는 객체로 변환해 주는 부분까지 살펴보았다. 이제 그 item을 consume하는 코드를 보자.

MainActivity.java
```java
github = new GithubClient();
disposable = github.getApi().getRepos(OWNER)
    .subscribeOn(Schedulers.io())
    .observeOn(AndroidSchedulers.mainThread())
    .subscribe( items -> adapter.updateItems(items));
```
예전에 비해서 바뀐 곳이 별로 없다. `github.getApi().getRepos(OWNER)`로 `Single`을 구독하고 있다가 데이터가 들어오게 되면 recycler view의 어뎁터에 전달해 준다.

사실 이게 코드의 끝이다. recycler view에 관한 내용은 이 글의 main topic이 아니므로 넘어가겠다. 자세한 내용은 [여기를](https://developer.android.com/reference/android/support/v7/widget/RecyclerView.html){:target="_blank"} 참고하기 바란다.

또, 파일이 많아지니 전체 프로젝트 코드를 저번처럼 gist로 올리는 건 너무 귀찮아서 그냥 Repository를 public으로 변경했다. 전체 코드를 보고 싶다면 [여기를](https://github.com/poqw/RxJavaToy){:target="_blank"} 클릭하자. 이제 public으로 바뀌었으니, 코드에 대해 개선점을 찾았거나 반대로 버그를 찾으신 분은 이슈에 남겨주시면 좋겠다. 이슈가 올라오면 감사한 마음으로 수정하도록 하겠다.

### 결과 화면
나의 public repository를 잘 받아와서 출력한다. 코드가 별 게 없는 만큼 딱히 다른 기능은 없다. 다만 보여지는 repo가 몇 개 없는 걸 보고 있자니 좀 머쓱한 기분이 든다. 이제 내가 얼마나 게으른지 이 글을 읽는 모두가 알게 될 것이다.
![]({{ site.url }}/assets/images/rxjava_2.png)


## Epilogue
---
Retrofit을 붙이다보니 욕심이 생겼는데, Dependency Injection 이나 Protocol Buffer 를 이용해서 더 예쁜 코드를 만들 수도 있을 것 같다는 생각이 들었다. 특히나 POJO를 사용한 부분이 너무나 마음에 안든다.

둘 중 어느 걸 더 먼저 적용해 볼지는 모르겠지만, Retrofit을 적용한 것과 마찬가지로 시간이 나면 코딩해서 올리도록 하겠다. 점점 RxJava와는 상관없는 내용으로 바뀌어 가고 있는 느낌인데, 이 시리즈로 계속 올릴지 새로운 시리즈로 올릴 지 고민된다.

\* 고민 후에, Dependency Injection은 개념 자체가 쉽지 않아서 따로 시리즈로 올리기로 했습니다.